name: Dev to Master Auto PR + Changelog

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: dev
          base: master
          title: "Merge dev into master"
          body: |
            Automated pull request from `dev` to `master`.

            Please fill out the **Changelog Entry** section before merging.
          draft: false

  update-changelog-and-merge:
    needs: create-pr
    runs-on: ubuntu-latest

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Get PR Info
        uses: actions/github-script@v7
        id: pr
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:dev`,
              base: 'master'
            });

            if (prs.data.length === 0) {
              core.setFailed('No open PR found.');
            }

            const pr = prs.data[0];
            core.setOutput('number', pr.number);
            core.setOutput('body', pr.body);

      - name: Extract Changelog Entry and append to CHANGELOG.md
        run: |
          PR_BODY="${{ steps.pr.outputs.body }}"
      
          echo "Extracting Changelog Entry..."
      
          CHANGELOG_ENTRY=$(echo "$PR_BODY" | awk '
            BEGIN {found=0}
            /^## Changelog Entry/ {found=1; next}
            /^## / && found {exit}
            found {print}
          ')
      
          if [ -z "$CHANGELOG_ENTRY" ]; then
            echo "âŒ No Changelog Entry found."
            exit 1
          fi
      
          {
            echo ""
            echo "## $(date +'%Y-%m-%d')"
            echo "$CHANGELOG_ENTRY"
          } >> CHANGELOG.md
      - name: Commit changelog
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "Update changelog from PR #${{ steps.pr.outputs.number }}"
          git push origin master

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }},
              merge_method: 'merge'
            });
